# 21강 GROUP BY, SUB QUERY

# GROUP BY

- 데이터를 특정 기준에 따라 그룹화하여 집계 함수를 사용하여 각 그룹에 대한 요약 정보를 얻는데 사용되는 절
- HAVING절로 그룹화된 데이터에 대한 추가적인 조건을 설정하는 데 사용됨

```sql
-- GROUP BY : ~별(ex: 포지션 별 평균 키)
-- SELECT ??? FROM ???
-- GROUP BY 컬럼명
-- WHERE 조건식
-- GROUP BY 컬럼명
-- HAVING 조건식
```

# GROUP BY 실습

```sql
-- PLAYER 테이블에서 포지션 검색
SELECT "POSITION" FROM PLAYER
GROUP BY "POSITION"
HAVING "POSITION" IS NOT NULL;
```

```sql
-- WHERE절에서 조건을 처리할 수 있다면 반드시 WHERE 절에서 먼저 처리해준다.
SELECT "POSITION" FROM PLAYER
WHERE "POSITION" IS NOT NULL 
GROUP BY "POSITION";
```

```sql
-- PLAYER 테이블에서 몸무게가 80이상인 선수들의 평균 키가 180이상인 포지션 검색
SELECT "POSITION", AVG(HEIGHT), MAX(WEIGHT) FROM PLAYER
WHERE WEIGHT >= 80
GROUP BY "POSITION"
HAVING AVG(HEIGHT) >= 180;
```

# SUB QUERY

- 쿼리 안의 또 다른 쿼리문

# SUB QUERY 종류

- FROM절 :
    - IN LINE VIEW
- SELECT절 :
    - SCALAR
- WHERE절 :
    - SUB QUERY

# SUB QUERY 실습

```sql
-- PLAYER 테이블에서 TEAM_ID가 'K01'인 선수 중 POSITION이 'GK'인 선수
SELECT * FROM
(
	SELECT * FROM PLAYER WHERE TEAM_ID = 'K01'
)
WHERE "POSITION" = 'GK';

SELECT * FROM PLAYER WHERE TEAM_ID = 'K01' AND "POSITION" = 'GK';
```

```sql
-- PLAYER 테이블에서 평균 키보다 작은 선수 검색
SELECT AVG(HEIGHT) FROM PLAYER;

SELECT * FROM PLAYER
WHERE WEIGHT < (SELECT AVG(HEIGHT) FROM PLAYER);
```

```sql
-- PLAYER 테이블에서 전체평균과 포지션 별 평균 키 구하기
SELECT "POSITION", AVG(HEIGHT), (SELECT AVG(HEIGHT) FROM PLAYER) FROM PLAYER
WHERE "POSITION" IS NOT NULL
GROUP BY "POSITION";
```

```sql
-- CASE문으로 변경
SELECT
	ROUND(AVG(CASE "POSITION" WHEN 'GK' THEN HEIGHT END), 2) AS GK,
	ROUND(AVG(CASE "POSITION" WHEN 'DF' THEN HEIGHT END), 2) AS DF,
	ROUND(AVG(CASE "POSITION" WHEN 'FW' THEN HEIGHT END), 2) AS FW,
	ROUND(AVG(CASE "POSITION" WHEN 'MF' THEN HEIGHT END), 2) AS MF,
	AVG(HEIGHT) AS "전체 평균" 
FROM PLAYER;
```

```sql
-- PLAYER 테이블에서 NICKNAME NULL인 선수들은 정태민 선수의 닉네임으로 바꾸기
SELECT * FROM PLAYER WHERE PLAYER_NAME = '정태민';

UPDATE PLAYER
SET NICKNAME = (SELECT NICKNAME FROM PLAYER WHERE PLAYER_NAME = '정태민')
WHERE NICKNAME IS NULL;

SELECT * FROM PLAYER WHERE NICKNAME = '킹카';
```

```sql
-- EMPLOYEES 테이블에서 평균 급여보다 낮은 사람들의 급여를 10% 인상
SELECT AVG(SALARY) FROM EMPLOYEES;
SELECT * FROM EMPLOYEES 
WHERE SALARY < (SELECT AVG(SALARY) FROM EMPLOYEES); -- Bruce

UPDATE EMPLOYEES
SET SALARY = SALARY * 1.1
WHERE SALARY < (SELECT AVG(SALARY) FROM EMPLOYEES);

SELECT * FROM EMPLOYEES;
```

```sql
-- PLAYER 테이블에서 평균 키보다 큰 선수들을 삭제
DELETE FROM PLAYER
WHERE HEIGHT > (SELECT AVG(HEIGHT) FROM PLAYER);

SELECT AVG(HEIGHT) FROM PLAYER; -- 179.31...

SELECT MAX(HEIGHT) FROM PLAYER;
```